# infrastructure/local/docker-compose.yml
version: '3.9'

services:
  # TigerGraph - Hybrid Vector/Graph Database (2025 standard)
  tigergraph:
    image: docker.tigergraph.com/tigergraph:latest
    ports:
      - "14240:14240"  # GraphStudio
      - "9000:9000"    # REST API
      - "10000:10000"  # GSQL Server
    environment:
      - TIGERGRAPH_USERNAME=tigergraph
      - TIGERGRAPH_PASSWORD=tigergraph123
    volumes:
      - tigergraph_data:/home/tigergraph/mydata
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Qdrant - High-performance Vector Database
  qdrant:
    image: qdrant/qdrant:v1.10.0
    ports:
      - "6333:6333"
      - "6334:6334"  # gRPC port
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__ENABLE_TLS=false
    command: ["./qdrant", "--config-path", "/qdrant/config/config.yaml"]

  # Redis Stack (includes RedisJSON, RedisGraph, RedisTimeSeries)
  redis-stack:
    image: redis/redis-stack:latest
    ports:
      - "6379:6379"
      - "8001:8001"  # RedisInsight
    volumes:
      - redis_data:/data
    environment:
      - REDIS_ARGS=--appendonly yes --appendfsync everysec

  # PostgreSQL with pgvector
  postgres:
    image: pgvector/pgvector:pg16
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=docintell
      - POSTGRES_PASSWORD=docintell123
      - POSTGRES_DB=document_intelligence
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql

  # Temporal for workflow orchestration
  temporal:
    image: temporalio/auto-setup:latest
    ports:
      - "7233:7233"
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=postgres
    depends_on:
      - postgres

  # Apache Pulsar for event streaming
  pulsar:
    image: apachepulsar/pulsar:3.2.0
    ports:
      - "6650:6650"
      - "8080:8080"
    volumes:
      - pulsar_data:/pulsar/data
    command: bin/pulsar standalone

  # LiveKit for real-time voice
  livekit:
    image: livekit/livekit-server:v1.6
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
    environment:
      - LIVEKIT_KEYS=devkey:secret
      - LIVEKIT_LOG_LEVEL=info
    command: --dev --redis-host redis-stack:6379

  # MinIO for object storage (S3 compatible)
  minio:
    image: minio/minio:latest
    ports:
      - "9001:9001"
      - "9002:9002"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9002"

volumes:
  tigergraph_data:
  qdrant_data:
  redis_data:
  postgres_data:
  pulsar_data:
  minio_data: